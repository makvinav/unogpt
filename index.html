<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UnoGPT</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Roboto, sans-serif;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff;overflow:hidden}
  canvas#particles{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1}
  .chat-title{font-size:36px;margin-bottom:16px}
  .chat-container{width:90%;max-width:720px;height:70vh;background:rgba(0,0,0,0.7);border-radius:12px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
  #chat{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:12px}
  .message{padding:10px 14px;border-radius:14px;max-width:78%;white-space:pre-wrap;word-wrap:break-word;opacity:0;transform:translateY(10px);animation:fadeIn .25s forwards}
  .user{align-self:flex-end;background:#4b9ce2;color:#fff}
  .gpt{align-self:flex-start;background:#222;color:#fff}
  @keyframes fadeIn{to{opacity:1;transform:translateY(0)}}
  #input-container{display:flex;padding:12px;border-top:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02)}
  #user-input{flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.06);color:#fff;font-size:15px;outline:none}
  #send-btn{padding:10px 14px;margin-left:10px;border-radius:10px;border:none;background:#4b9ce2;color:#fff;cursor:pointer;min-width:110px}
  .rotating{width:16px;height:16px;border:2px solid #fff;border-radius:3px;animation:spin 1s linear infinite;display:block}
  @keyframes spin{to{transform:rotate(360deg)}}
  .meta{font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px}
</style>
</head>
<body>
<canvas id="particles"></canvas>
<h1 class="chat-title">UnoGPT</h1>

<div class="chat-container" role="main">
  <div id="chat"></div>
  <div id="input-container">
    <input id="user-input" type="text" placeholder="Напишите сообщение..." />
    <button id="send-btn">Отправить</button>
  </div>
</div>
<div class="meta" style="text-align:center">Сервер должен быть запущен и доступен — backend скрывает твой ключ</div>

<script>
/* === particles background === */
const canvas = document.getElementById('particles');
const ctx = canvas.getContext('2d');
let particles = [];
function resize() { canvas.width = innerWidth; canvas.height = innerHeight; }
window.addEventListener('resize', resize); resize();
class P{constructor(){this.x=Math.random()*canvas.width;this.y=Math.random()*canvas.height;this.r=Math.random()*2.5+0.5;this.vx=(Math.random()-0.5)*0.4;this.vy=(Math.random()-0.5)*0.4}upd(){this.x+=this.vx;this.y+=this.vy;if(this.x<0||this.x>canvas.width)this.vx*=-1;if(this.y<0||this.y>canvas.height)this.vy*=-1}draw(){ctx.fillStyle='rgba(255,255,255,0.6)';ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill()}}
function init(){particles=[];for(let i=0;i<100;i++)particles.push(new P())}init();
function loop(){ctx.clearRect(0,0,canvas.width,canvas.height);for(const p of particles){p.upd();p.draw()}requestAnimationFrame(loop)}loop();

/* === chat logic === */
const chat = document.getElementById('chat');
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');

let controller = null;
let isGenerating = false;
let typingInterval = null;

function addMessage(text, cls){
  const el = document.createElement('div');
  el.className = 'message ' + cls;
  el.textContent = text;
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
  return el;
}

async function sendMessage(){
  if(isGenerating){
    if(controller) controller.abort();
    stopTyping();
    resetButton();
    return;
  }
  const msg = input.value.trim();
  if(!msg) return;
  addMessage(msg, 'user');
  input.value = '';
  changeButtonToStop();
  isGenerating = true;
  controller = new AbortController();

  let reply = '';
  try{
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ message: msg }),
      signal: controller.signal
    });
    const data = await res.json();
    // если сервер вернул error — показываем сообщение
    if(res.status !== 200){
      reply = data?.error || data?.reply || "Ошибка: сервер вернул статус " + res.status;
    } else {
      reply = data.reply || "";
    }
  }catch(err){
    if(err.name === 'AbortError') reply = '⛔ Ответ остановлен';
    else { console.error(err); reply = 'Ошибка: не удалось получить ответ'; }
  }

  simulateTyping(reply);
}

function simulateTyping(text){
  const el = addMessage('', 'gpt');
  let i = 0;
  typingInterval = setInterval(()=>{
    if(i < text.length){
      el.textContent += text[i++];
      chat.scrollTop = chat.scrollHeight;
    } else {
      stopTyping();
      resetButton();
    }
  }, 25);
}

function stopTyping(){ if(typingInterval){ clearInterval(typingInterval); typingInterval = null; } }
function changeButtonToStop(){ sendBtn.innerHTML = ''; const s = document.createElement('span'); s.className = 'rotating'; sendBtn.appendChild(s); sendBtn.style.background = '#e24b4b'; isGenerating = true; }
function resetButton(){ sendBtn.innerHTML = 'Отправить'; sendBtn.style.background = '#4b9ce2'; isGenerating = false; controller = null; }

sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keypress', e=> { if(e.key === 'Enter') sendMessage(); });
</script>
</body>
</html>